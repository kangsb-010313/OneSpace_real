<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="perforinfo">

  <!-- 전체 개수 -->
  <select id="count" resultType="long">
    select count(*) from infoWrite
  </select>

  <!-- 페이징 리스트 -->
  <select id="list_paged" parameterType="map" resultType="com.javaex.vo.PerforInfoVO">
    select
      iw.infoPostNo     as infoPostNo,
      iw.userNo         as userNo,
      iw.infoPostTitle  as infoPostTitle,
      iw.agencyName     as agencyName,
      iw.infoContent    as infoContent,
      iw.infoOutUrl     as infoOutUrl,
      iw.infoPostType   as infoPostType,
      iw.deadlineDate   as deadlineDate,
      iw.infoArea       as infoArea,
      iw.infoImg        as infoImg,
      iw.infoWriteDate  as infoWriteDate,
      iw.infoUpdateDate as infoUpdateDate,
      u.userName        as username
    from infoWrite iw
    left join users u on u.userNo = iw.userNo
    order by iw.infoWriteDate desc, iw.infoPostNo desc
    limit #{offset}, #{size}
  </select>

  <!-- 단건 조회 -->
  <select id="get" parameterType="long" resultType="com.javaex.vo.PerforInfoVO">
    select
      iw.infoPostNo     as infoPostNo,
      iw.userNo         as userNo,
      iw.infoPostTitle  as infoPostTitle,
      iw.agencyName     as agencyName,
      iw.infoContent    as infoContent,
      iw.infoOutUrl     as infoOutUrl,
      iw.infoPostType   as infoPostType,
      iw.deadlineDate   as deadlineDate,
      iw.infoArea       as infoArea,
      iw.infoImg        as infoImg,
      iw.infoWriteDate  as infoWriteDate,
      iw.infoUpdateDate as infoUpdateDate,
      u.userName        as username
    from infoWrite iw
    left join users u on u.userNo = iw.userNo
    where iw.infoPostNo = #{no}
  </select>

  <!-- 등록 (auto_increment 키 반환) -->
  <!-- KST로 고정 저장: 서버가 UTC라면 CONVERT_TZ로 서울시간 저장 -->
  <insert id="insert" parameterType="com.javaex.vo.PerforInfoVO" useGeneratedKeys="true" keyProperty="infoPostNo">
    insert into infoWrite
      (userNo, infoPostTitle, agencyName, infoContent, infoOutUrl,
       infoPostType, deadlineDate, infoArea, infoImg, infoWriteDate, infoUpdateDate)
    values
      (#{userNo}, #{infoPostTitle}, #{agencyName}, #{infoContent}, #{infoOutUrl},
       #{infoPostType}, #{deadlineDate}, #{infoArea}, #{infoImg},
       CONVERT_TZ(UTC_TIMESTAMP(),'UTC','Asia/Seoul'),
       CONVERT_TZ(UTC_TIMESTAMP(),'UTC','Asia/Seoul'))
  </insert>
  
    <!-- 수정 -->
  <update id="update" parameterType="com.javaex.vo.PerforInfoVO">
    update infoWrite
    <set>
      <if test="infoPostTitle != null">infoPostTitle = #{infoPostTitle},</if>
      <if test="agencyName    != null">agencyName    = #{agencyName},</if>
      <if test="infoContent   != null">infoContent   = #{infoContent},</if>
      <if test="infoOutUrl    != null">infoOutUrl    = #{infoOutUrl},</if>
      <if test="infoPostType  != null">infoPostType  = #{infoPostType},</if>
      <if test="deadlineDate  != null">deadlineDate  = #{deadlineDate},</if>
      <if test="infoArea      != null">infoArea      = #{infoArea},</if>
      <!-- 새 파일을 올린 경우에만 이미지 갱신 -->
      <if test="infoImg       != null">infoImg       = #{infoImg},</if>

      infoUpdateDate = CONVERT_TZ(UTC_TIMESTAMP(),'UTC','Asia/Seoul')
    </set>
    where infoPostNo = #{infoPostNo}
      and userNo     = #{userNo}
  </update>

</mapper>
