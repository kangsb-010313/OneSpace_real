<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="teampage">

<!-- 쿼리문 작성 -->

	<!-- 팀 생성 (teams 테이블) -->
    <insert id="insertTeam" parameterType="com.javaex.vo.TeamVO">
        insert into teams (
            teamName, 
            instaAccount, 
            teamCreatedDate,
            userNo        
        )
        values (
            #{teamName}, 
            #{instaAccount}, 
            now(),
            #{userNo}     
        )
    </insert>

    <!-- 특정 사용자가 가장 마지막에 만든 팀의 ID(teamNo)를 조회하는 쿼리 -->
    <select id="selectNewTeamNo" parameterType="int" resultType="int">
        select max(teamNo)
        from teams
        where userNo = #{userNo}
    </select>
    
    <!-- 팀원 등록 (teamMembers 테이블) - position, status 컬럼 추가 -->
    <insert id="insertTeamMember" parameterType="map">
        insert into teamMembers (
            teamNo, 
            userNo, 
            joinedDate,
            position,
            status
        )
        values (
            #{teamNo}, 
            #{userNo}, 
            now(),
            #{position},
            #{status}
        )
    </insert>
    

    <!-- 유저 번호로 소속된 팀 목록 조회 (teammain aside용) -->
    <!-- teamMembers 테이블은 user와 team의 관계를 정의하는 테이블로 가정 -->
	<select id="selectTeamsByUserNo" parameterType="int" resultType="com.javaex.vo.TeamVO">
	    <![CDATA[
	        select  t.teamNo,
	                t.teamName
	        from teams t, teamMembers tm 
	        where t.teamNo = tm.teamNo
	        and tm.userNo = #{userNo}
	        and tm.status = '승인'
	        order by t.teamName asc
	    ]]>
	</select>


    <!-- 유저가 소속된 모든 팀의 게시글 조회 (teammain content용) -->
	<select id="selectPostsByUserTeams" parameterType="int" resultType="com.javaex.vo.TeamPostVO">
	    <![CDATA[
	        select  p.teamPostNo,
	                p.teamNo,
	                p.userNo,
	                p.teamPostType,
	                p.teamPostTitle,
	                date_format(p.teamWriteDate, '%Y-%m-%d') as teamWriteDate,
	                t.teamName
	        from posts p
	        join teams t on p.teamNo = t.teamNo
	        where p.teamNo in (select teamNo 
	                           from teamMembers   
	                           where userNo = #{userNo}
	                           and status = '승인')
	        order by p.teamWriteDate desc, p.teamPostNo desc
	    ]]>
	</select>





	<!-- 팀페이지 리스트(팀선택시) -->
	<select id="selectListByTeamNo" parameterType="int" resultType="com.javaex.vo.TeamPostVO">
		<![CDATA[
			SELECT  p.teamPostNo,
                    p.teamNo,
                    p.userNo,
                    p.teamPostType,
                    p.teamPostTitle,
                    p.teamContent,
                    date_format(p.teamWriteDate, '%Y-%m-%d') as teamWriteDate,
                    date_format(p.teamUpdateDate, '%Y-%m-%d') as teamUpdateDate,
                    u.userName,   -- users 테이블에서 작성자 이름 가져오기
                    t.teamName    -- teams 테이블에서 팀 이름 가져오기
            from posts p
            join users u on p.userNo = u.userNo
            join teams t on p.teamNo = t.teamNo
            where p.teamNo = #{teamNo}
            order by p.teamWriteDate desc, p.teamPostNo desc
		]]>
	</select>
	
	
    <!-- 모든 팀 목록 조회 -->
    <select id="selectAllTeams" resultType="com.javaex.vo.TeamVO">
        <![CDATA[
            select teamNo, teamName
            from teams
            order by teamName asc
        ]]>
    </select>

    <!-- 특정 팀 정보 조회 (팀 이름 등을 가져올 때 사용) -->
    <select id="selectTeamInfoByNo" parameterType="int" resultType="com.javaex.vo.TeamVO">
        <![CDATA[
            select teamNo, teamName, instaAccount, teamCreatedDate
            from teams
            where teamNo = #{teamNo}
        ]]>
    </select>
    
    
    <!-- 게시글 상세 조회, 수정폼 -->
    <select id="selectPostByNo" parameterType="int" resultType="com.javaex.vo.TeamPostVO">
        <![CDATA[
            select  p.teamPostNo,
                    p.teamNo,
                    p.userNo,
                    p.teamPostType,
                    p.teamPostTitle,
                    p.teamContent,
                    date_format(p.teamWriteDate, '%Y-%m-%d') as teamWriteDate,
                    date_format(p.teamUpdateDate, '%Y-%m-%d') as teamUpdateDate,
                    u.userName,
                    t.teamName,
                    t.instaAccount
            from posts p
            join users u ON p.userNo = u.userNo
            join teams t ON p.teamNo = t.teamNo
            where p.teamPostNo = #{teamPostNo}
        ]]>
    </select>
    

	<!-- 팀페이지 글 등록 -->
	<insert id="insert" parameterType="com.javaex.vo.TeamPostVO">
		<![CDATA[
			insert into posts(teamPostNo, teamNo, teamPostType, teamPostTitle, teamContent, teamWriteDate, userNo)
			values(null, #{teamNo}, #{teamPostType}, #{teamPostTitle}, #{teamContent}, now(), #{userNo})
		]]>
	</insert>
	
	<!-- 특정 유저가 가장 마지막에 등록한 게시글의 번호를 가져오는 쿼리 -->
	<select id="selectLastPostNo" parameterType="int" resultType="int">
	    <![CDATA[
	        select max(teamPostNo)
	        from posts
	        where userNo = #{userNo}
	    ]]>
	</select>
	
	<!-- 첨부파일 정보 저장 쿼리 (이전과 동일) -->
	<insert id="insertAttachment" parameterType="com.javaex.vo.TeamAttachmentsVO">
	    <![CDATA[
	        insert into teamAttachments (
	            postNo, teamStoredFileName, teamOriginFileName, teamFilePath, 
	            teamFileCreatedDate, teamFileUpdateDate
	        ) values (
	            #{postNo}, #{teamStoredFileName}, #{teamOriginFileName}, #{teamFilePath},
	            now(), now()
	        )
	    ]]>
	</insert>
	
	<!-- 특정 게시글에 속한 모든 첨부파일 목록 조회 -->
	<select id="selectAttachmentsByPostNo" parameterType="int" resultType="com.javaex.vo.TeamAttachmentsVO">
	    <![CDATA[
	        select  teamfileNo,
	                postNo,
	                teamStoredFileName,
	                teamOriginFileName,
	                teamFilePath
	        from teamAttachments
	        where postNo = #{postNo}
	        order by teamfileNo ASC
	    ]]>
	</select>
	
	<!-- 게시글 수정 -->
    <update id="update" parameterType="com.javaex.vo.TeamPostVO">
        <![CDATA[
            update posts
            set teamPostType = #{teamPostType},
                teamPostTitle = #{teamPostTitle},
                teamContent = #{teamContent},
                teamUpdateDate = now()
            where teamPostNo = #{teamPostNo}
        ]]>
    </update>
	
	
    <!-- 게시글 삭제 -->
    <delete id="delete" parameterType="int">
        <![CDATA[
            delete from posts
            where teamPostNo = #{teamPostNo}
        ]]>
    </delete>

	<!-- 특정 게시글의 모든 첨부파일 삭제 -->
	<delete id="deleteAttachmentsByPostNo" parameterType="int">
	    <![CDATA[
	        delete from teamAttachments
	        where postNo = #{postNo}
	    ]]>
	</delete>
    
    
	<!-- 투표 만들기를 위해 사용자의 '찜 목록'에 있는 연습실 정보 가져오기 -->
	<select id="selectWishlistForVote" parameterType="int" resultType="com.javaex.vo.TeamVoteOptionVO">
	    <![CDATA[
	        select
	            s.spacesNo,
	            s.spaceName,
	            s.address,
	            r.roomNo,
	            r.roomName,
	            r.area,
	            r.capacity
	        from
	            studioWishlist w  -- 찜 목록 테이블에서 시작
	        join
	            rooms r ON w.roomNo = r.roomNo
	        join
	            spaces s ON r.spacesNo = s.spacesNo
	        where
	            w.userNo = #{userNo} -- 로그인한 사용자의 찜 목록만 조회
	        order by
	            w.studioWishlistNo DESC -- 가장 최근에 찜한 순서대로
	    ]]>
	</select>

	<!-- 특정 팀(teamNo)에 특정 유저(userNo)가 속해있는지 확인 -->
	<select id="selectMemberCount" parameterType="map" resultType="int">
		select count(*)
		from teamMembers
		where userNo = #{userNo}
		  and teamNo = #{teamNo}
		  and status = '승인'
	</select>
    
    
    <!-- 특정 팀의 첫 게시글 번호(teamPostNo의 최소값)를 조회 -->
	<select id="selectFirstPostNo" parameterType="int" resultType="java.lang.Integer">
	    select min(teamPostNo)
	    from posts
	    where teamNo = #{teamNo}
	</select>
	
	
	<!-- 팀원 관리: 특정 팀의 모든 멤버 정보 조회 (users 테이블과 JOIN) -->
	<select id="selectMembersByTeamNo" parameterType="int" resultType="com.javaex.vo.TeamMemberVO">
	    select
	        tm.teamMemberNo,
	        tm.teamNo,
	        tm.userNo,
	        u.userName,  -- users 테이블에서 이름 가져오기
	        tm.position,
	        tm.status,
	        date_format(tm.joinedDate, '%Y-%m-%d') as joinedDate -- 날짜 형식을 YYYY-MM-DD로 지정
	    from teamMembers tm
	    join users u on tm.userNo = u.userNo
	    where tm.teamNo = #{teamNo}
	    order by
	        case
	            when tm.position = '팀장' THEN 1
	            when tm.status = '승인' THEN 2
	            else 3
	        end,
	        tm.joinedDate asc,
	        u.userName asc
	</select>
	
	<!-- 특정 유저가 특정 팀의 '팀장'인지 확인하는 쿼리 -->
	<select id="isUserTeamLeader" parameterType="map" resultType="int">
	    select count(*)
	    from teamMembers
	    where userNo = #{userNo}
	      and teamNo = #{teamNo}
	      and position = '팀장'
	</select>
	
	<!-- 팀원 관리: 가입 신청 승인 (상태를 '승인'으로, 가입일을 오늘 날짜로 변경) -->
	<update id="updateMemberStatus" parameterType="map">
	    update teamMembers
	    set status = #{status},
	        joinedDate = curdate() 
	    where userNo = #{userNo}
	      and teamNo = #{teamNo}
	</update>
	
	<!-- 팀원 관리: 가입 거부 또는 멤버 삭제 -->
	<delete id="deleteMember" parameterType="map">
	    delete from teamMembers
	    where userNo = #{userNo}
	      and teamNo = #{teamNo}
	</delete>
	
	
	<!-- 투표 만들기를 위해 날짜/시간이 지정된 후보 목록을 조회하는 쿼리 (roomAttachments 테이블 사용) -->
	<select id="selectVoteCandidates" parameterType="int" resultType="com.javaex.vo.TeamVotePostVO">
	    <![CDATA[
	        SELECT
	            v.voteNo,
	            s.spaceName,
	            r.roomName,
	            r.roomNo,
	            SUBSTRING_INDEX(SUBSTRING_INDEX(s.address, ' ', 2), ' ', -1) AS address,
	            vo.voteDate,
	            
	            /* ▼▼▼▼▼ 핵심: 시간을 그룹화하여 시작-종료 시간으로 표시 ▼▼▼▼▼ */
	            MIN(vo.voteTime) AS startTime, /* 가장 빠른 시간을 시작 시간으로 */
	            TIME_FORMAT(ADDTIME(MAX(vo.voteTime), '01:00:00'), '%H:%i') AS endTime, /* 가장 늦은 시간에 1시간을 더해 종료 시간으로 */
	            /* ▲▲▲▲▲ 여기까지 ▲▲▲▲▲ */
	
	            v.totalPrice,
	            (
	                SELECT storedFileName 
	                FROM roomAttachments 
	                WHERE roomNo = r.roomNo 
	                LIMIT 1
	            ) AS picturesNo,
	            (
	                SELECT GROUP_CONCAT(fi.facilityName SEPARATOR ', ')
	                FROM spacesGuide sg
	                JOIN facilityInfo fi ON sg.facilityNo = fi.facilityNo
	                WHERE sg.spacesNo = s.spacesNo
	                  AND fi.facilityName IN ('주차', '조명', '블루투스 스피커')
	            ) AS spacesGuideNo
	            
	        FROM votes v
	        
	        JOIN voteOptions vo ON v.voteNo = vo.voteNo
	        JOIN rooms r ON vo.roomNo = r.roomNo
	        JOIN spaces s ON r.spacesNo = s.spacesNo
	
	        WHERE v.userNo = #{userNo}
	          AND v.postNo IS NULL
	          AND vo.voteStatus = 0
	        
	        /* ▼▼▼▼▼ 핵심: voteNo와 날짜 등으로 그룹화하여 하나의 후보로 묶음 ▼▼▼▼▼ */
	        GROUP BY v.voteNo, s.spaceName, r.roomName, r.roomNo, s.address, vo.voteDate, v.totalPrice
	        /* ▲▲▲▲▲ 여기까지 ▲▲▲▲▲ */
	          
	        ORDER BY vo.voteDate, startTime
	    ]]>
	</select>
	
	<!-- postNo로 해당 게시글의 투표 후보 목록 조회 -->
	<select id="selectVoteOptionsByPostNo" parameterType="int" resultType="com.javaex.vo.TeamVotePostVO">
	    <![CDATA[
	        SELECT
	            v.voteNo,
	            s.spaceName,
	            r.roomName,
	            r.roomNo,
	            SUBSTRING_INDEX(SUBSTRING_INDEX(s.address, ' ', 2), ' ', -1) AS address,
	            vo.voteDate,
	            MIN(vo.voteTime) AS startTime,
	            TIME_FORMAT(ADDTIME(MAX(vo.voteTime), '01:00:00'), '%H:%i') AS endTime,
	            v.totalPrice,
	            (
	                SELECT storedFileName 
	                FROM roomAttachments 
	                WHERE roomNo = r.roomNo 
	                LIMIT 1
	            ) AS picturesNo,
	            (
	                SELECT GROUP_CONCAT(fi.facilityName SEPARATOR ', ')
	                FROM spacesGuide sg
	                JOIN facilityInfo fi ON sg.facilityNo = fi.facilityNo
	                WHERE sg.spacesNo = s.spacesNo
	                  AND fi.facilityName IN ('주차', '조명', '블루투스 스피커')
	            ) AS spacesGuideNo
	        FROM votes v
	        JOIN voteOptions vo ON v.voteNo = vo.voteNo
	        JOIN rooms r ON vo.roomNo = r.roomNo
	        JOIN spaces s ON r.spacesNo = s.spacesNo
	        WHERE v.postNo = #{postNo} /* <-- 이 조건이 핵심! */
	        GROUP BY v.voteNo, s.spaceName, r.roomName, r.roomNo, s.address, vo.voteDate, v.totalPrice
	        ORDER BY vo.voteDate, startTime
	    ]]>
	</select>
	
	<!-- mybatis/mappers/teampage.xml -->

	<!-- 1. votes 테이블에 postNo 업데이트 -->
	<!-- ▼▼▼▼▼ 이 쿼리를 교체해주세요 ▼▼▼▼▼ -->
	<update id="updatePostNoInVotes" parameterType="map">
	    UPDATE votes
	    SET postNo = #{postNo}
	    WHERE voteNo IN
	    <!-- collection에 Map의 key인 "voteNoList"를 명시 -->
	    <foreach item="voteNo" index="index" collection="voteNoList" open="(" separator="," close=")">
	        #{voteNo}
	    </foreach>
	</update>
	
	<!-- 2. voteOptions 테이블의 status를 1(투표중)로 업데이트 -->
	<!-- ▼▼▼▼▼ 이 쿼리를 교체해주세요 ▼▼▼▼▼ -->
	<update id="updateStatusInVoteOptions" parameterType="map">
	    UPDATE voteOptions
	    SET voteStatus = 1
	    WHERE voteNo IN
	    <!-- collection에 Map의 key인 "voteNoList"를 명시 -->
	    <foreach item="voteNo" index="index" collection="voteNoList" open="(" separator="," close=")">
	        #{voteNo}
	    </foreach>
	</update>
	
    

</mapper>