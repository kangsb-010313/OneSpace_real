<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="practiceroom">
	
	<select id="selectList" resultType="com.javaex.vo.SpacesVO">
		<![CDATA[
        SELECT
          spacesNo,
          userNo,
          spaceName,
          spaceSummary,
          spaceInfo,
          email,
          phone,
          tel,
          spaceLink,
          postCode,
          address,
          addressDetail,
          instDtm,
          updtDtm
		FROM spaces
		ORDER BY spacesNo
	    ]]>
    </select>
    
    <select id="selectPaged" parameterType="map" resultType="com.javaex.vo.SpacesVO">
	  SELECT
	    spacesNo,
        userNo,
        spaceName,
        spaceSummary,
        spaceInfo,
	    email,
        phone,
        tel,
        spaceLink,
        postCode,
        address,
        addressDetail,
	    instDtm,
        updtDtm
	  FROM spaces
	  ORDER BY spacesNo
	  LIMIT #{offset,jdbcType=INTEGER}, #{size,jdbcType=INTEGER}
	</select>
    
    <!-- 특정 공간 상세 -->
    <select id="selectZoneDetail" parameterType="long" resultType="com.javaex.vo.SpacesVO">
        SELECT
          spacesNo,
          userNo,
          spaceName,
          spaceSummary,
          spaceInfo,
          email,
          phone,
          tel,
          spaceLink,
          postCode,
          address,
          addressDetail,
          instDtm,
          updtDtm
        FROM spaces
        WHERE spacesNo = #{spacesNo}
    </select>

    <!-- 특정 공간의 방 리스트 -->
    <select id="selectRoomsBySpace" parameterType="long" resultType="com.javaex.vo.RoomsVO">
        SELECT
          roomNo,
          spacesNo,
          roomName,
          roomInfo,
          area,
          capacity,
          instDtm,
          updtDtm
        FROM rooms
        WHERE spacesNo = #{spacesNo}
        ORDER BY roomNo
    </select>
    
    <select id="selectFavoriteSpaces" parameterType="long" resultType="com.javaex.vo.SpacesVO">
	  SELECT
	      r.roomNo,
	      s.spacesNo,
	      s.userNo,
	      s.spaceName,
	      s.spaceSummary,
	      s.spaceInfo,
	      s.email,
	      s.phone,
	      s.tel,
	      s.spaceLink,
	      s.postCode,
	      s.address,
	      s.addressDetail,
	      s.instDtm,
	      s.updtDtm,
	      COALESCE(
	        CONCAT(ra.filePath, ra.storedFileName),
	        CASE
	          WHEN LOWER(s.spaceLink) REGEXP '^(https?://).*(\\.(jpg|jpeg|png|gif|webp))(\\?.*)?$'
	            THEN s.spaceLink
	          WHEN LOWER(s.spaceLink) REGEXP '(\\.(jpg|jpeg|png|gif|webp))$'
	            THEN CONCAT('/assets/images/', s.spaceLink)
	          ELSE '/assets/images/연습실찜하기사진01.jpg'
	        END
	      ) AS imageUrl
	  FROM studioWishlist sw
	  JOIN rooms r   ON r.roomNo   = sw.roomNo
	  JOIN spaces s  ON s.spacesNo = r.spacesNo
	  LEFT JOIN (
	      SELECT roomNo, MIN(picturesNo) AS minPic
	      FROM roomAttachments
	      GROUP BY roomNo
	  ) pick ON pick.roomNo = r.roomNo
	  LEFT JOIN roomAttachments ra ON ra.picturesNo = pick.minPic
	  WHERE sw.userNo = #{userNo}
	  ORDER BY sw.studioWishlistNo DESC
	</select>
	
	<!-- 후보 리스트(오른쪽 패널) -->
	<select id="selectFavoriteCandidates" parameterType="long" resultType="java.util.Map">
	  <![CDATA[
	  SELECT
	    s.spaceName,
	    r.roomNo,
	    v.voteDate,
	    CAST(SUBSTRING_INDEX(SUBSTRING_INDEX(v.voteTime,'~', 1), ':', 1) AS UNSIGNED) AS startHour,
	    CAST(SUBSTRING_INDEX(SUBSTRING_INDEX(v.voteTime,'~',-1), ':', 1) AS UNSIGNED) AS endHour,
	    (
	      CAST(SUBSTRING_INDEX(SUBSTRING_INDEX(v.voteTime,'~',-1), ':', 1) AS UNSIGNED) -
	      CAST(SUBSTRING_INDEX(SUBSTRING_INDEX(v.voteTime,'~', 1), ':', 1) AS UNSIGNED)
	    ) AS durationHours,
	    CASE WHEN DAYOFWEEK(v.voteDate) IN (1,7) THEN '주말' ELSE '평일' END AS dayType,
	    (
	      (
	        CAST(SUBSTRING_INDEX(SUBSTRING_INDEX(v.voteTime,'~',-1), ':', 1) AS UNSIGNED) -
	        CAST(SUBSTRING_INDEX(SUBSTRING_INDEX(v.voteTime,'~', 1), ':', 1) AS UNSIGNED)
	      ) * COALESCE(CAST(rp.hourlyPrice AS UNSIGNED), 0)
	    ) AS totalPrice,
	    (
	      SELECT COUNT(*)
	      FROM voteOptions vv
	      WHERE vv.roomNo   = v.roomNo
	        AND vv.voteDate = v.voteDate
	        AND vv.voteTime = v.voteTime
	    ) AS hotCount
	  FROM voteOptions v
	  JOIN rooms  r ON r.roomNo   = v.roomNo
	  JOIN spaces s ON s.spacesNo = r.spacesNo
	  LEFT JOIN roomPrices rp
	         ON rp.roomNo  = r.roomNo
	        AND rp.dayType = (CASE WHEN DAYOFWEEK(v.voteDate) IN (1,7) THEN '주말' ELSE '평일' END)
	        AND rp.startTime <= MAKETIME(
	              CAST(SUBSTRING_INDEX(SUBSTRING_INDEX(v.voteTime,'~', 1), ':', 1) AS UNSIGNED),0,0)
	        AND rp.endTime   >= MAKETIME(
	              CAST(SUBSTRING_INDEX(SUBSTRING_INDEX(v.voteTime,'~',-1), ':', 1) AS UNSIGNED),0,0)
	  WHERE v.userNo = #{userNo}
	  ORDER BY v.voteDate, startHour, s.spacesNo
	  ]]>
	</select>
	
	<!-- 시간대/요일별 요금 조회 -->
	<select id="selectRoomPricesByDate" parameterType="com.javaex.vo.ReserveInfoVO" resultType="com.javaex.vo.RoomPriceVO">
	  SELECT
	    pricesNo,
	    roomNo,
	    dayType,
	    startTime,
	    endTime,
	    hourlyPrice
	  FROM roomPrices
	  WHERE roomNo = #{roomNo}
	    AND dayType = CASE
	      WHEN DAYOFWEEK(#{targetDate}) IN (1, 7) THEN '주말'
	      ELSE '평일'
	    END
	  ORDER BY startTime
	</select>

</mapper>