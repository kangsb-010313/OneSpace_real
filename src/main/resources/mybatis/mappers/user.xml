<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="user">

  <!-- 회원가입: PK 자동 채움 -->
  <insert id="insert"
          parameterType="com.javaex.vo.UserVO"
          useGeneratedKeys="true" keyProperty="userNo">
    INSERT INTO users
      (userId, password, userName, email, createdDate)
    VALUES
      (#{userId}, #{password}, #{userName}, #{email}, NOW())
  </insert>

  <!-- 로그인 -->
  <select id="selectOneByIdPw"
          parameterType="com.javaex.vo.UserVO"
          resultType="com.javaex.vo.UserVO">
    SELECT
      userNo,
      userId,
      userName,
      email,
      createdDate
    FROM users
    WHERE userId = #{userId}
      AND password = #{password}
    LIMIT 1
  </select>

  <!-- kakaoId로 단건 조회 -->
  <select id="selectOneByKakaoId"
          parameterType="string"
          resultType="com.javaex.vo.UserVO">
    SELECT
      userNo,
      userId,
      kakaoId,
      password,
      userName,
      email,
      createdDate
    FROM users
    WHERE kakaoId = #{value}
    LIMIT 1
  </select>

  <!-- email로 단건 조회 -->
  <select id="selectOneByEmail"
          parameterType="string"
          resultType="com.javaex.vo.UserVO">
    SELECT
      userNo,
      userId,
      kakaoId,
      password,
      userName,
      email,
      createdDate
    FROM users
    WHERE email = #{value}
    LIMIT 1
  </select>

  <!-- 카카오 최초가입 -->
  <insert id="insertKakao"
          parameterType="com.javaex.vo.UserVO"
          useGeneratedKeys="true" keyProperty="userNo">
    INSERT INTO users
      (userId, kakaoId, password, userName, email, createdDate)
    VALUES
      (
        CASE
          WHEN #{userId} IS NOT NULL THEN #{userId}
          ELSE CONCAT('kakao_', #{kakaoId})
        END,
        #{kakaoId},
        NULL,
        #{userName},
        #{email},
        NOW()
      )
  </insert>

  <!-- 기존 회원에 kakaoId 연동 -->
  <update id="updateKakaoIdByUserNo" parameterType="com.javaex.vo.UserVO">
    UPDATE users
    SET kakaoId = #{kakaoId}
    WHERE userNo = #{userNo}
  </update>

  <!-- 카카오 로그인 시 프로필(닉네임/이메일) 갱신 -->
  <update id="updateKakaoProfileByUserNo" parameterType="com.javaex.vo.UserVO">
    UPDATE users
    SET
      userName = COALESCE(#{userName}, userName),
      email    = COALESCE(#{email},    email)
    WHERE userNo = #{userNo}
  </update>

</mapper>
