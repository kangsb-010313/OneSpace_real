<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.javaex.repository.PrideRepository">

  <!-- =========================
       카드 목록 (페이징)
       - WHERE 조건은 countPride와 완전히 동일
       - writeDateText: 날짜만(YYYY-MM-DD)
       - thumbnailUrl: 첨부 1장만 가져와 가공
  ========================== -->
  <select id="selectPrideCards" resultType="com.javaex.vo.PrideVO">
    SELECT
      p.teamPostNo      AS teamPostNo,
      p.teamNo          AS teamNo,
      p.teamPostTitle   AS teamPostTitle,
      p.teamContent     AS teamContent,
      p.teamWriteDate   AS teamWriteDate,
      p.teamUpdateDate  AS teamUpdateDate,
      DATE_FORMAT(p.teamWriteDate, '%Y-%m-%d') AS writeDateText,
      t.teamName        AS teamName,
      COALESCE(t.instaAccount, '') AS instaAccount,
      (
        SELECT CONCAT(
                 '/uploads/',
                 CASE
                   WHEN a.teamFilePath IS NULL OR a.teamFilePath = ''
                     THEN a.teamStoredFileName
                   WHEN SUBSTRING_INDEX(REPLACE(a.teamFilePath,'\\','/'), '/', -1) = a.teamStoredFileName
                     THEN a.teamStoredFileName
                   ELSE CONCAT(
                          TRIM(BOTH '/' FROM REPLACE(a.teamFilePath,'\\','/')),
                          '/',
                          a.teamStoredFileName
                        )
                 END
               )
        FROM teamAttachments a
        WHERE a.postNo = p.teamPostNo
        ORDER BY a.teamFileNo ASC
        LIMIT 1
      ) AS thumbnailUrl
    FROM posts p
    LEFT JOIN teams t ON t.teamNo = p.teamNo
    WHERE 1=1
      <if test="teamNo != null">
        AND p.teamNo = #{teamNo}
      </if>
      <choose>
        <!-- 서비스에서 type을 넘기면 그 값만 -->
        <when test="teamPostType != null and teamPostType != ''">
          AND p.teamPostType = #{teamPostType}
        </when>
        <!-- type이 비어오면 TEAM_PRIDE/팀자랑/NULL 포함 -->
        <otherwise>
          AND (p.teamPostType IN ('TEAM_PRIDE','팀자랑') OR p.teamPostType IS NULL)
        </otherwise>
      </choose>
    ORDER BY p.teamPostNo DESC
    LIMIT #{limit} OFFSET #{offset}
    <!-- 또는: LIMIT #{offset}, #{limit} (MySQL 버전에 따라 선택) -->
  </select>

  <!-- =========================
       총 개수 (목록과 WHERE 완전 동일)
  ========================== -->
  <select id="countPride" resultType="int">
    SELECT COUNT(1)
    FROM posts p
    WHERE 1=1
      <if test="teamNo != null">
        AND p.teamNo = #{teamNo}
      </if>
      <choose>
        <when test="teamPostType != null and teamPostType != ''">
          AND p.teamPostType = #{teamPostType}
        </when>
        <otherwise>
          AND (p.teamPostType IN ('TEAM_PRIDE','팀자랑') OR p.teamPostType IS NULL)
        </otherwise>
      </choose>
  </select>

  <!-- =========================
       상세 (1건)
       - writeDateText: 날짜만(YYYY-MM-DD)
  ========================== -->
  <select id="selectPrideDetail" resultType="com.javaex.vo.PrideVO">
    SELECT
      p.teamPostNo,
      p.teamNo,
      p.teamPostTitle,
      p.teamContent,
      p.teamWriteDate,
      p.teamUpdateDate,
      DATE_FORMAT(p.teamWriteDate, '%Y-%m-%d') AS writeDateText,
      t.teamName,
      t.instaAccount
    FROM posts p
    LEFT JOIN teams t ON t.teamNo = p.teamNo
    WHERE p.teamPostNo = #{id}
      <choose>
        <when test="teamPostType != null and teamPostType != ''">
          AND p.teamPostType = #{teamPostType}
        </when>
        <otherwise>
          AND (p.teamPostType IN ('TEAM_PRIDE','팀자랑') OR p.teamPostType IS NULL)
        </otherwise>
      </choose>
    LIMIT 1
  </select>

  <!-- =========================
       상세 이미지 목록 (URL 가공)
  ========================== -->
  <select id="selectPrideImages" resultType="string">
    SELECT CONCAT(
             '/uploads/',
             CASE
               WHEN teamFilePath IS NULL OR teamFilePath = ''
                 THEN teamStoredFileName
               WHEN RIGHT(REPLACE(teamFilePath,'\\','/'), LENGTH(teamStoredFileName)) = teamStoredFileName
                 THEN teamStoredFileName
               ELSE CONCAT(
                      TRIM(BOTH '/' FROM REPLACE(teamFilePath,'\\','/')),
                      '/',
                      teamStoredFileName
                    )
             END
           ) AS url
    FROM teamAttachments
    WHERE postNo = #{id}
    ORDER BY teamFileNo ASC
  </select>

</mapper>
