<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="room">

  <sql id="room_cols">
    r.roomNo   AS roomNo,
    r.spacesNo AS spacesNo,
    r.roomName AS roomName,
    r.roomInfo AS roomInfo,
    r.area     AS area,
    r.capacity AS capacity,
    r.instDtm  AS instDtm,
    r.updtDtm  AS updtDtm
  </sql>

  <!-- 특정 공간의 방 목록 -->
  <select id="select_rooms_by_spacesno" parameterType="long" resultType="com.javaex.vo.RoomsVO">
    SELECT <include refid="room_cols"/>
    FROM rooms r
    WHERE r.spacesNo = #{value}
    ORDER BY r.roomNo DESC
  </select>

  <!-- 방 상세 -->
  <select id="select_room_detail" parameterType="long" resultType="com.javaex.vo.RoomsVO">
    SELECT <include refid="room_cols"/>
    FROM rooms r
    WHERE r.roomNo = #{value}
    LIMIT 1
  </select>

  <!-- 방 신규 등록 -->
  <insert id="insert_room" parameterType="com.javaex.vo.RoomsVO"
          useGeneratedKeys="true" keyProperty="roomNo" keyColumn="roomNo">
    INSERT INTO rooms (
      spacesNo, roomName, roomInfo, area, capacity, instDtm, updtDtm
    ) VALUES (
      #{spacesNo}, #{roomName}, #{roomInfo}, #{area}, #{capacity}, NOW(), NOW()
    )
  </insert>

  <!-- 방 수정 -->
  <update id="update_room" parameterType="com.javaex.vo.RoomsVO">
    UPDATE rooms
       SET roomName = #{roomName},
           roomInfo = #{roomInfo},
           area     = #{area},
           capacity = #{capacity},
           updtDtm  = NOW()
     WHERE roomNo  = #{roomNo}
  </update>

  <!-- 방 삭제 -->
  <delete id="delete_room" parameterType="long">
    DELETE FROM rooms WHERE roomNo = #{value}
  </delete>

  <!-- ==================== prices (RoomPriceVO) ==================== -->
  <resultMap id="RoomPricesMap" type="com.javaex.vo.RoomPriceVO">
    <id     property="priceNo"    column="priceNo"/>
    <result property="roomNo"     column="roomNo"/>
    <result property="dayType"    column="dayType"/>
    <result property="startTime"  column="startTime"/>
    <result property="endTime"    column="endTime"/>
    <result property="hourlyPrice" column="hourlyPrice"/>
  </resultMap>

  <insert id="insert_price" parameterType="com.javaex.vo.RoomPriceVO"
          useGeneratedKeys="true" keyProperty="priceNo" keyColumn="priceNo">
    INSERT INTO roomPrices (
      roomNo, dayType, startTime, endTime, hourlyPrice
    ) VALUES (
      #{roomNo}, #{dayType}, #{startTime}, #{endTime}, #{hourlyPrice}
    )
  </insert>

  <delete id="delete_prices_by_room" parameterType="long">
    DELETE FROM roomPrices WHERE roomNo = #{value}
  </delete>

  <select id="select_prices" parameterType="long" resultMap="RoomPricesMap">
    SELECT priceNo, roomNo, dayType, startTime, endTime, hourlyPrice
    FROM roomPrices
    WHERE roomNo = #{value}
    ORDER BY priceNo ASC
  </select>

  <!-- ==================== photos ==================== -->
  <resultMap id="RoomPhotoMap" type="com.javaex.vo.RoomsVO$RoomAttachment">
    <id     property="pictureSno"     column="pictureSno"/>
    <result property="roomNo"         column="roomNo"/>
    <result property="storedFileName" column="storedFileName"/>
    <result property="originFileName" column="originFileName"/>
    <result property="filePath"       column="filePath"/>
    <result property="instDt"         column="instDt"/>
    <result property="updtDt"         column="updtDt"/>
  </resultMap>

  <insert id="insert_photo" parameterType="com.javaex.vo.RoomsVO$RoomAttachment"
          useGeneratedKeys="true" keyProperty="pictureSno" keyColumn="pictureSno">
    INSERT INTO roomAttachments (
      roomNo, storedFileName, originFileName, filePath, instDt, updtDt
    ) VALUES (
      #{roomNo}, #{storedFileName}, #{originFileName}, #{filePath}, NOW(), NOW()
    )
  </insert>

  <select id="select_photos" parameterType="long" resultMap="RoomPhotoMap">
    SELECT pictureSno, roomNo, storedFileName, originFileName, filePath, instDt, updtDt
    FROM roomAttachments
    WHERE roomNo = #{value}
    ORDER BY pictureSno ASC
  </select>

  <delete id="delete_photos_by_room" parameterType="long">
    DELETE FROM roomAttachments WHERE roomNo = #{value}
  </delete>

</mapper>
