<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="room">

  <!-- rooms + prices JOIN 결과 매핑 -->
  <resultMap id="rooms_with_prices_rm" type="com.javaex.vo.RoomsVO">
    <!-- rooms -->
    <id     property="roomNo"   column="roomNo"/>
    <result property="spacesNo" column="spacesNo"/>
    <result property="roomName" column="roomName"/>
    <result property="roomInfo" column="roomInfo"/>
    <result property="area"     column="area"/>
    <result property="capacity" column="capacity"/>
    <result property="thumbImg" column="thumbImg"/>
    <result property="instDtm"  column="r_instDtm"/>
    <result property="updtDtm"  column="r_updtDtm"/>

    <!-- prices (LEFT JOIN) -->
    <collection property="prices" ofType="com.javaex.vo.RoomPriceVO">
      <id     property="pricesNo"    column="pricesNo"/>
      <result property="roomNo"      column="p_roomNo"/>
      <result property="dayType"     column="dayType"/>
      <result property="startTime"   column="startTime" jdbcType="TIME"/>
      <result property="endTime"     column="endTime"   jdbcType="TIME"/>
      <result property="hourlyPrice" column="hourlyPrice"/>
      <result property="instDtm"     column="p_instDtm"/>
      <result property="updtDtm"     column="p_updtDtm"/>
    </collection>
  </resultMap>

  <!-- 첨부이미지 매핑 -->
  <resultMap id="room_attachment_rm" type="com.javaex.vo.RoomsVO$RoomAttachment">
    <id     property="pictureSno"     column="pictureSno"/>
    <result property="refType"        column="refType"/>
    <result property="refNo"          column="refNo"/>
    <result property="storedFileName" column="storedFileName"/>
    <result property="originFileName" column="originFileName"/>
    <result property="filePath"       column="filePath"/>
    <result property="fileSize"       column="fileSize"/>
    <result property="contentType"    column="contentType"/>
    <result property="instDtm"        column="instDtm"/>
    <result property="updtDtm"        column="updtDtm"/>
  </resultMap>

  <!-- =========== SELECTS =========== -->

  <!-- 상세: room + prices[] (JOIN 한 번) -->
  <select id="select_room_with_prices" parameterType="long" resultMap="rooms_with_prices_rm">
    SELECT
      r.roomNo, r.spacesNo, r.roomName, r.roomInfo, r.area, r.capacity, r.thumbImg,
      r.instDtm AS r_instDtm, r.updtDtm AS r_updtDtm,
      p.pricesNo, p.roomNo AS p_roomNo, p.dayType, p.startTime, p.endTime, p.hourlyPrice,
      p.instDtm AS p_instDtm, p.updtDtm AS p_updtDtm
    FROM rooms r
    LEFT JOIN roomPrices p ON p.roomNo = r.roomNo
    WHERE r.roomNo = #{value}
    ORDER BY p.dayType ASC, p.startTime ASC, p.pricesNo ASC
  </select>

  <!-- 사진 목록 -->
  <select id="select_photos" parameterType="long" resultMap="room_attachment_rm">
    SELECT
      picturesNo AS pictureSno,
      refType,
      roomNo     AS refNo,
      storedFileName, originFileName, filePath, fileSize, contentType,
      instDtm, updtDtm
    FROM roomAttachments
    WHERE refType = 'ROOM' AND roomNo = #{value}
    ORDER BY picturesNo ASC
  </select>

  <!-- =========== INSERT / UPDATE =========== -->

  <insert id="insert_room" parameterType="com.javaex.vo.RoomsVO" useGeneratedKeys="true" keyProperty="roomNo">
    INSERT INTO rooms (spacesNo, roomName, roomInfo, area, capacity, thumbImg, instDtm, updtDtm)
    VALUES (#{spacesNo}, #{roomName}, #{roomInfo}, #{area}, #{capacity}, #{thumbImg}, NOW(), NOW())
  </insert>

  <update id="update_room" parameterType="com.javaex.vo.RoomsVO">
    UPDATE rooms
       SET roomName = #{roomName},
           roomInfo = #{roomInfo},
           area     = #{area},
           capacity = #{capacity},
           thumbImg = #{thumbImg},
           updtDtm  = NOW()
     WHERE roomNo = #{roomNo}
  </update>

  <!-- 가격 완전 교체용 -->
  <delete id="delete_prices_by_room" parameterType="long">
    DELETE FROM roomPrices WHERE roomNo = #{value}
  </delete>

  <insert id="insert_prices_batch" parameterType="java.util.List">
    INSERT INTO roomPrices (roomNo, dayType, startTime, endTime, hourlyPrice, instDtm, updtDtm)
    VALUES
    <foreach collection="list" item="p" separator=",">
      (#{p.roomNo},
       #{p.dayType},
       #{p.startTime, jdbcType=TIME},
       #{p.endTime,   jdbcType=TIME},
       #{p.hourlyPrice},
       NOW(), NOW())
    </foreach>
  </insert>

  <!-- 사진 교체 -->
  <delete id="delete_photos_by_room" parameterType="long">
    DELETE FROM roomAttachments WHERE refType='ROOM' AND roomNo = #{value}
  </delete>

  <insert id="insert_photo"
          parameterType="com.javaex.vo.RoomsVO$RoomAttachment"
          useGeneratedKeys="true" keyProperty="pictureSno">
    INSERT INTO roomAttachments (
      refType, roomNo, storedFileName, originFileName,
      filePath, fileSize, contentType, instDtm, updtDtm
    ) VALUES (
      #{refType}, #{refNo}, #{storedFileName}, #{originFileName},
      #{filePath}, #{fileSize}, #{contentType}, NOW(), NOW())
  </insert>

</mapper>
