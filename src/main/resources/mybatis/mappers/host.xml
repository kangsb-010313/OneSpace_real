<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="host">

  <!-- HostVO(전부 소문자)와 1:1로 맞춘 별칭 -->
  <sql id="space_cols">
    spacesNo      AS spacesno,
    userNo        AS userno,
    spaceName     AS spacename,
    spaceSummary  AS spacesummary,
    spaceInfo     AS spaceinfo,
    email         AS email,
    phone         AS phone,
    tel           AS tel,
    spaceLink     AS spacelink,
    postCode      AS postcode,
    address       AS address,
    addressDetail AS addressdetail,
    repImg        AS repimg,
    instDtm       AS inst_dt,
    updtDtm       AS updt_dt
  </sql>

  <!-- 단건 조회 -->
  <select id="space_by_userNo" parameterType="long" resultType="com.javaex.vo.HostVO">
    SELECT <include refid="space_cols"/>
    FROM spaces
    WHERE userNo = #{userNo}
  </select>

  <!-- [추가] 전체 시설 목록을 조회하는 쿼리 -->
  <select id="selectAllFacilities" resultType="com.javaex.vo.FacilityInfoVO">
      SELECT
          facilityNo,
          facilityName
      FROM facilityInfo
      ORDER BY facilityNo ASC
  </select>


  <!-- 선택한 시설관리 -->
  <select id="selectCheckedFacilities" parameterType="long"  resultType="com.javaex.vo.FacilityInfoVO">
      select  f.facilityNo,
	          f.facilityName,
        	  s.spacesGuideNo
	  from facilityInfo f left join (select spacesGuideNo,
			        						facilityNo
							         from spacesGuide
							         where spacesNo = #{spacesNo}) s
      on f.facilityNo = s.facilityNo
  </select>


  <!-- 로그인 사용자별 목록 -->
  <select id="spaces_by_user" parameterType="long" resultType="com.javaex.vo.HostVO">
    SELECT <include refid="space_cols"/>
    FROM spaces
    WHERE userNo = #{value}
    ORDER BY spacesNo DESC
  </select>



  <!-- 단건 조회 -->
  <select id="space_by_no" parameterType="long" resultType="com.javaex.vo.HostVO">
    SELECT <include refid="space_cols"/>
    FROM spaces
    WHERE spacesNo = #{value}
  </select>

  <!-- 신규 저장 -->
  <insert id="insert_space"
          parameterType="com.javaex.vo.HostVO"
          useGeneratedKeys="true"
          keyProperty="spacesno">
    INSERT INTO spaces (
      userNo, spaceName, spaceSummary, spaceInfo,
      email, phone, tel, spaceLink,
      postCode, address, addressDetail,
      repImg, instDtm, updtDtm
    )
    VALUES (
      #{userno}, #{spacename}, #{spacesummary}, #{spaceinfo},
      #{email}, #{phone}, #{tel}, #{spacelink},
      #{postcode}, #{address}, #{addressdetail},
      #{repimg}, NOW(), NOW()
    )
  </insert>

  <!-- 수정 저장 -->
  <update id="update_space" parameterType="com.javaex.vo.HostVO">
    UPDATE spaces
    SET
      spaceName     = #{spacename},
      spaceSummary  = #{spacesummary},
      spaceInfo     = #{spaceinfo},
      email         = #{email},
      phone         = #{phone},
      tel           = #{tel},
      spaceLink     = #{spacelink},
      postCode      = #{postcode},
      address       = #{address},
      addressDetail = #{addressdetail},
      repImg        = #{repimg},
      updtDtm       = NOW()
    WHERE spacesNo = #{spacesno}
  </update>



  <!-- (선택) 시설 1건 삽입 -->
  <insert id="insert_facility" parameterType="com.javaex.vo.FacilityInfoVO">
    INSERT INTO spacesGuide (spacesNo, facilityNo)
    VALUES (#{spacesNo}, #{facilityNo})
  </insert>

</mapper>
