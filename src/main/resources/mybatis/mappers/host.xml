<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="host">

  <!-- 공통 컬럼 -->
  <sql id="space_cols">
    spacesNo      AS spacesno,
    userNo        AS userno,
    spaceName     AS spacename,
    spaceSummary  AS spacesummary,
    spaceInfo     AS spaceinfo,
    email         AS email,
    phone         AS phone,
    tel           AS tel,
    spaceLink     AS spacelink,
    postCode      AS postcode,
    address       AS address,
    addressDetail AS addressdetail,
    instDtm       AS inst_dt,
    updtDtm       AS updt_dt
  </sql>

  <!-- 로그인 사용자 공간 목록 -->
  <select id="spaces_by_user" parameterType="long" resultType="com.javaex.vo.HostVO">
    SELECT <include refid="space_cols"/>
    FROM spaces
    WHERE userNo = #{value}
    ORDER BY instDtm DESC, spacesNo DESC
  </select>

  <!-- 단건 조회 -->
  <select id="space_by_no" parameterType="long" resultType="com.javaex.vo.HostVO">
    SELECT <include refid="space_cols"/>
    FROM spaces
    WHERE spacesNo = #{value}
    LIMIT 1
  </select>

  <!-- 신규 생성 -->
  <insert id="insert_space" parameterType="com.javaex.vo.HostVO"
          useGeneratedKeys="true" keyProperty="spacesno" keyColumn="spacesNo">
    INSERT INTO spaces (
      userNo, spaceName, spaceSummary, spaceInfo,
      email, phone, tel, spaceLink,
      postCode, address, addressDetail,
      instDtm, updtDtm
    ) VALUES (
      #{userno}, #{spacename}, #{spacesummary}, #{spaceinfo},
      #{email}, #{phone}, #{tel}, #{spacelink},
      #{postcode}, #{address}, #{addressdetail},
      NOW(), NOW()
    )
  </insert>

  <!-- 수정 -->
  <update id="update_space" parameterType="com.javaex.vo.HostVO">
    UPDATE spaces
       SET spaceName     = #{spacename},
           spaceSummary  = #{spacesummary},
           spaceInfo     = #{spaceinfo},
           email         = #{email},
           phone         = #{phone},
           tel           = #{tel},
           spaceLink     = #{spacelink},
           postCode      = #{postcode},
           address       = #{address},
           addressDetail = #{addressdetail},
           updtDtm       = NOW()
     WHERE spacesNo = #{spacesno}
       AND userNo   = #{userno}
  </update>

  <!-- ===== 시설(facilityInfo) ===== -->

  <!-- 한 공간의 시설 전체 삭제(업데이트/재저장 시 사용) -->
  <delete id="delete_facilities_by_spacesno" parameterType="long">
    DELETE FROM facilityInfo WHERE spacesNo = #{value}
  </delete>

  <!-- 시설 한 건 삽입 -->
  <insert id="insert_facility">
    INSERT INTO facilityInfo (spacesNo, facilityName, instDtm, updtDtm)
    VALUES (#{spacesNo}, #{facilityName}, NOW(), NOW())
  </insert>

  <!-- 조회(필요 시) -->
  <select id="select_facilities_by_spacesno" parameterType="long" resultType="string">
    SELECT facilityName
    FROM facilityInfo
    WHERE spacesNo = #{value}
    ORDER BY facilityName
  </select>

</mapper>
